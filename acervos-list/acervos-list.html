<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../polymer/lib/elements/dom-if.html">
<link rel="import" href="../../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../acervos-card/acervos-card.html">
<link rel="import" href="../acervos-card-show/acervos-card-show.html">

<dom-module id="acervos-list">
  <template>
    <style>
      :host {
        --paper-spinner-color: #00a9eb;
        display: block;
        position: relative;
        overflow: auto;
        height: 100%;
      }
      .show-less, .show-more {
        text-align: center;
        position: relative;
        padding: 10px;
      }
      .results paper-icon-button {
        color: var(--default-primary-color);
        background: var(--primary-background-color);
        border-radius: 50%;
        padding: 5px;
      }
      .spinner {
        text-align: center;
        position: absolute;
        left: 0;
        right: 0;
      }
      .spinner paper-spinner {
        background: var(--primary-background-color);
        border-radius: 50%;
        padding: 5px;
      }
      .results {
        padding: 10px;
      }
      .results .list {
        -moz-column-width: 19em;
        -webkit-column-width: 19em;
        column-width: 19em;
        -moz-column-gap: 1.2em;
        -webkit-column-gap: 1.2em;
        column-gap: 1.2em;
      }
    </style>
    <acervos-service id="ajax" api="{{server}}" loading="{{loading}}"
      service="{{service}}"  result="{{result}}" params="{{params}}"
      method="{{method}}"  body="{{body}}" error="{{error}}">
    </acervos-service>
    <div class="results" id="results">
      <div class="list">
        <dom-repeat items="{{resultItems}}">
          <template>
            <acervos-card card-item="{{item}}" server="{{server}}"
              project-id="{{projectId}}" on-show-item="presentShow">
            </acervos-card>
          </template>
        </dom-repeat>
      </div>
      <div class="show-more">
        <dom-if if="{{loading}}">
          <template>
            <div class="spinner">
              <paper-spinner elevation="1" active></paper-spinner>
            </div>
          </template>
        </dom-if>
        <dom-if if="{{!loading}}">
          <template>
            <paper-icon-button elevation="1"
              on-tap="_loadMore" icon="expand-more">
            </paper-icon-button>
          </template>
        </dom-if>
      </div>
    </div>
  </template>
  <script>
    /**
     * `acervos-list`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class AcervosList extends Polymer.Element {
      static get is() {
        return 'acervos-list';
      }
      static get properties() {
        return {
          project: {
            type: Object,
          },
          projectId: {
            type: String,
            reflectToAttribute: true,
            observer: 'projectChanged'
          },
          server: {
            type: String,
            value: ''
          },
          resultItems: {
            value() { return []; },
          },
          service: {
            observer: 'generateRequest'
          },
          result: {
            observer: 'animateItems'
          },
          loading: {
            type: Boolean,
            value: false
          },
          more: {
            type: Boolean,
            value: false,
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.onscroll = function(e) {
          const moreOffset = this.$.results.querySelector('.show-more').offsetTop;
          const scrollTop  = e.target.scrollTop + e.target.clientHeight;
          if(scrollTop >= moreOffset && !this.more) {
            this._loadMore();
          }
        }.bind(this);
      }

      computeService(projectId, more) {
        this.service = undefined;

        if (more) this.__skip = this.__skip  + 50 || 0;
        let query = '';
        if(this.__skip)
          query = `?skip=${this.__skip}&limit=50`;
        if (!projectId) return;
        this.service = `projects/${projectId}/pubitems${query}`;
      }

      animateItems(result) {
        if(!result || !result.results.length) return;
        this.resultItems = this.resultItems.concat(result.results.map((item) => {
          if(item._data.RelatedMedias) {
            item._data.RelatedMedias._files = Array.from(item._data.RelatedMedias._medias);
            delete item._data.RelatedMedias._medias;
          }
          return Object.assign({}, ...Object.values(item._data));
        }));
        this.set('more', false);
      }

      projectChanged(projectId) {
        if(!projectId) return;
        this.resultItems = [];
        this.__skip = 0;
        this.set('more', false);
        this.computeService(projectId, this.more);
      }

      generateRequest() {
        if (!this.service) return;
        this.$.ajax.generateRequest();
      }

      presentShow(e) {
        this.dispatchEvent(new CustomEvent('show', { detail: { item: e.detail.cardItem },
          bubbles: true, composed: true }));
      }

      dismissShow(e) {
        this.$.show.cardItem = undefined;
      }

      _loadMore(e) {
        if(!this.resultItems.length) return;
        this.set('more', true);
        this.computeService(this.projectId, this.more);
      }
    }

    window.customElements.define(AcervosList.is, AcervosList);
  </script>
</dom-module>
