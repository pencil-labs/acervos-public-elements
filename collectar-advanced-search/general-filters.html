<link rel="import" href="../../polymer/polymer.html">

<link rel="import" href="../../paper-range-slider/paper-range-slider.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-checkbox/paper-checkbox.html">

<dom-module id="general-filters">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div class="container">
      <div class="production">
        <h3>Produção</h3>
        <div class="type">
          <paper-dropdown-menu label="Tipo">
            <paper-listbox slot="dropdown-content"
              attr-for-selected="name" fallback-selection="fullDate"
              selected="{{dateType}}">
              <paper-item name="fullDate">Data</paper-item>
              <paper-item name="decades">Intervalo</paper-item>
              <paper-item name="year">Ano exato</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
        <div class="dates">
          <iron-pages selected="{{dateType}}" attr-for-selected="name">
            <div name="fullDate">
              <paper-input label="Produção" type="date" id="fullDate"
                on-value-changed="setDateFilter"></paper-input>
            </div>
            <div name="decades">
              <paper-input label="Entre o ano" type="number" id="fromDate"
                on-value-changed="setDateFilter"></paper-input>
              <paper-input label="E o ano" type="number" id="toDate"
                on-value-changed="setDateFilter"></paper-input>
            </div>
            <div name="year">
              <paper-input label="No ano" type="number" id="year"
                on-value-changed="setDateFilter"></paper-input>
            </div>
          </iron-pages>
        </div>
      </div>
    </div>
  </template>
  <script>
    class GeneralFilters extends Polymer.Element {
      static get is() { return 'general-filters'; }
      static get properties() {
        return {
          total: {
            type: Number,
            observer: 'computeMax'
          },
          filter: {
            type: Object,
            notify: true
          },
          min: Number,
          max: Number,
          hasFilter: {
            type: Boolean,
            notify: true
          }
        };
      }
      static get observers() { return ['setRegisterInterval(min, max)']; }

      setGeneralFilters(e) {
        this.setConditionState(e);
        this.setAuthorFilter(e);
        this.setCollectionFilter(e);
        this.notifyPath('filter');
        this.verifyFilter();
      }

      setConditionState(e) {
        const state = e.target.getAttribute('name');
        if(e.target.tagName !== 'PAPER-CHECKBOX') return;
        if(!e.detail.value) {
          const i = this.filter.state ? this.filter.state.indexOf(state) : -1;
          if(i >= 0) this.filter.state.splice(i, 1);
          if(!i && !this.filter.state.length) delete this.filter.state;
        } else {
          if(!this.filter.state) this.filter.state = [];
          this.filter.state.push(state);
        }
      }

      setRegisterInterval(min, max) {
        const diff = this.max - this.min;
        if(!(diff >= this.total) && !(this.max > this.total)) {
          this.filter.regNumber = {
            type: 'interval',
            lower: this.min,
            greater: this.max
          };
        } else {
          delete this.filter.regNumber;
        }
        this.verifyFilter();
      }

      setAuthorFilter(e) {
        if(e.target.id !== 'author') return;
        if(!e.detail.value) delete this.filter.author;
        else this.filter.author = e.detail.value;
      }
      setCollectionFilter(e) {
        if(e.target.id !== 'collection') return;
        if(!e.detail.value) delete this.filter.category;
        else this.filter.category = e.detail.value;
      }
      computeMax(total) {
        this.max = total;
      }

      verifyFilter() {
        this.hasFilter = !!this.filter.state || !!this.filter.regNumber ||
        !!this.filter.author || !!this.filter.category;
      }
      
    }
    customElements.define(GeneralFilters.is, GeneralFilters);
  </script>
</dom-module>
