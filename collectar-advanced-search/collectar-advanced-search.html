<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../paper-tabs/paper-tabs.html">
<link rel="import" href="../../paper-tabs/paper-tab.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-badge/paper-badge.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="./fjm-filters.html">
<link rel="import" href="../collectar-icons/collectar-icons.html">

<dom-module id="collectar-advanced-search">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
      .content {
        display: grid;
      }
      paper-button {
        justify-self: right;
        font-size: 0.8rem;
        margin-top: 5px;
      }
      
    </style>
    <collectar-service id="ajax" api="{{server}}" loading="{{loading}}"
      service="{{service}}" result="{{result}}" params="{{params}}"
      method="{{method}}" body="{{body}}" error="{{error}}">
    </collectar-service>
    <div class="content">
      <fjm-filters total="{{registerCount}}" filter="{{filter}}">
      </fjm-filters>
      <paper-button raised on-tap="submitFilters">Buscar</paper-button>
    </div>
  </template>

  <script>
    /**
     * `collectar-advanced-search`
     * Collectar element with advanced search options, ranges and fields.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CollectarAdvancedSearch extends Polymer.Element {
      static get is() { return 'collectar-advanced-search'; }
      static get properties() {
        return {
          selected: {
            type: String,
            observer: 'clearOptionName'
          },
          filter: {
            type: Object,
            value() {return {}; },
            notify: true
          },
          isMobile: Boolean,
          optionName: {
            type: String,
            value: 'Mais'
          },
          registerCount: Number
        };
      }

      static get observers() {
        return [];
      }

      ready() {
        super.ready();
        this.isMobile = screen.width  <= 420;
      }

      selectTab(e) {
        if(!this.isMobile) return;
        const listbox = this.shadowRoot.querySelector('paper-listbox');
        if(!listbox) return;
        if(!e.detail.value) {
          const item = listbox.focusedItem;
          this.optionName = item.innerHTML;
          const moreTab = this.shadowRoot.querySelector('#more');
          moreTab.setAttribute('name', item.getAttribute('name'));
          this.selected = item.getAttribute('name');
        }
      }

      clearOptionName(selected) {
        this.fireContentChange(selected);
        if(['dates', 'places'].includes(selected)) return;
        this.optionName = 'Mais';
        const moreTab = this.shadowRoot.querySelector('#more');
        if(!moreTab) return;
        moreTab.setAttribute('name', 'more');
      }

      fireContentChange(selected) {
        this.dispatchEvent(new CustomEvent('content-changed', {
          detail: { value: selected }
        }));
      }

      setFiltersBadge(e) {
        const filters = e.detail.value;
        const tabName = e.target.getAttribute('name');
        let tab = this.shadowRoot.querySelector(`paper-tab[name="${tabName}"]`);
        if(this.isMobile && ['dates', 'places'].includes(tabName))
          tab = this.shadowRoot.querySelector('paper-menu-button span');
        if(!tab) return;
        const badge = tab.querySelector('paper-badge') || document.createElement('paper-badge');
        badge.icon = 'app:report';
        badge.for = tabName;
        if(filters) {
          tab.appendChild(badge);
        } else if(!!tab.querySelector('paper-badge')) {
          tab.removeChild(badge);
        }
      }

      submitFilters(e) {
        this.dispatchEvent(new CustomEvent('filter', { detail: { filter: this.filter } }));
      }
    }

    window.customElements.define(CollectarAdvancedSearch.is, CollectarAdvancedSearch);
  </script>
</dom-module>
